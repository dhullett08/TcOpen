using NUnit.Framework;
using TcoPneumatics;
using Tc.Prober.Runners;
using Tc.Prober.Recorder;
using System.Reflection;
using System.IO;

namespace nUnitTcOpenTests
{
    public class fbCylinderTests
    {
        fbCylinder sut;

        [OneTimeSetUp()]
        public void OneTimeSetUp()
        {
            Entry.TcoPneumaticsPlc.Connector.BuildAndStart();
            sut = Entry.TcoPneumaticsPlc.MAIN._wpfCyclinder;
            var executingAssembly = new FileInfo(Assembly.GetExecutingAssembly().Location);
            Runner.RecordingsShell = Path.GetFullPath(Path.Combine(executingAssembly.DirectoryName, @"..\..\..\recodrings"));            
        }

        [SetUp]
        public void TestSetup()
        {
            sut.Run(a => a._StopTest());
        }

        [Test]
        // [Timeout(10000)]
        public void MoveCylinderToHomeTest()
        {
            sut.Run(a =>
            {
                var done = a._MoveToHomeTest();
                Entry.TcoPneumaticsPlc.IO.A1[0].Synchron = true;
                Entry.TcoPneumaticsPlc.IO.A1[1].Synchron = false;
                return done;
            });


            Assert.IsFalse(sut.inAtWorkPos.Synchron);
            Assert.IsTrue(sut.inAtHomePos.Synchron);
            Assert.IsTrue(sut.outToHomePos.Synchron);
            Assert.False(sut.outToWorkPos.Synchron);
        }

        
        [Test]
        [Timeout(10000)]
        public void MoveCylinderToWorkTest()
        {
            sut.Run(a =>
            {
                var done = a._MoveToWorkTest();
                Entry.TcoPneumaticsPlc.IO.A1[0].Synchron = false;
                Entry.TcoPneumaticsPlc.IO.A1[1].Synchron = true;
                return done;
            });
            Assert.IsTrue(sut.inAtWorkPos.Synchron);
            Assert.IsFalse(sut.inAtHomePos.Synchron);
            Assert.IsFalse(sut.outToHomePos.Synchron);
            Assert.IsTrue(sut.outToWorkPos.Synchron);
        }

        [Test]
        [Timeout(10000)]
        public void StopCyclinderTest()
        {
            sut.Run(a =>
            {
                var done = a._StopTest();              
                return done;
            });

            Assert.IsFalse(sut.outToHomePos.Synchron);
            Assert.IsFalse(sut.outToWorkPos.Synchron);
        }

        private RecorderModeEnum mode = RecorderModeEnum.Player;
        

        [Test]
        [Timeout(10000)]
        public void MoveCylinderToWorkTestWithRecording()
        {                      
            var actor = new Recorder<IO, PlainIO>(Entry.TcoPneumaticsPlc.IO, mode, 1).Actor;
            var done = false;

            sut.Run(() => { done = sut._MoveToWorkTest(); return done; },
                    () => { return done; },
                    null,
                    null,
                    actor,
                    Path.Combine(Runner.RecordingsShell, $"{nameof(MoveCylinderToWorkTestWithRecording)}.json"));

            Assert.IsTrue(sut.inAtWorkPos.Synchron);
            Assert.IsFalse(sut.inAtHomePos.Synchron);
            Assert.IsFalse(sut.outToHomePos.Synchron);
            Assert.IsTrue(sut.outToWorkPos.Synchron);
        }

        [Test]
        [Timeout(10000)]
        public void MoveCylinderToHomeTestWithRecording()
        {
            var actor = new Recorder<IO, PlainIO>(Entry.TcoPneumaticsPlc.IO, mode, 1).Actor;
            var done = false;

            sut.Run(() => { done = sut._MoveToHomeTest(); return done; },
                    () => { return done; },
                    null,
                    null,
                    actor,
                    Path.Combine(Runner.RecordingsShell, $"{nameof(MoveCylinderToHomeTestWithRecording)}.json"));

            Assert.IsFalse(sut.inAtWorkPos.Synchron);
            Assert.IsTrue(sut.inAtHomePos.Synchron);
            Assert.IsTrue(sut.outToHomePos.Synchron);
            Assert.False(sut.outToWorkPos.Synchron);
        }
    }
}